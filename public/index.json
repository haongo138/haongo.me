[{"content":"TLDR;\nSau khi gáº·p khÃ¡ nhiá»u váº¥n Ä‘á» vá»›i lÆ°á»£ng lá»›n python DAG khi upgrade, viáº¿t giÃºp dag \u0026amp; sau má»™t thá»i gian thÃ nh con rÆ¡i, khÃ´ng ai maintain ná»¯a.\nMÃ¬nh tin ráº±ng nháº¥t Ä‘á»‹nh cÃ³ má»™t cÃ¡ch viáº¿t dags khÃ¡c:\n ÄÆ¡n giáº£n \u0026amp; hiá»‡u quáº£ hÆ¡n tháº¿ 500 anh em BA, Analytics cÃ³ thá»ƒ dá»… dÃ ng tá»± viáº¿t pipelines cho riÃªng mÃ¬nh mÃ  khÃ´ng pháº£i tá»‘n quÃ¡ nhiá»u cÃ´ng sá»©c Dá»… dÃ ng cho viá»‡c monitor, alerting khi cÃ³ biáº¿n xáº£y ra Upgrade core cá»§a airflow khÃ´ng cáº§n pháº£i thay Ä‘á»•i cÃ¡c dags config hiá»‡n táº¡i.  KÃ© vÃ i miáº¿ng quáº£ng cÃ¡o\n Báº¡n Ä‘ang mong muá»‘n tÃ¬m kiáº¿m cÆ¡ há»™i má»›i Báº¡n muá»‘n lÃ m viá»‡c vá»›i nhá»¯ng cÃ´ng nghá»‡ big data tá»‘i tÃ¢n nháº¥t. XÃ i serveless tá»‘n kÃ©m quÃ¡ vá»›i cháº­m cháº¡p, báº¡n cÃ³ thá»ƒ tá»± build \u0026amp; publish cho hÆ¡n 500 anh em TIKI xÃ i.  Äáº¿n ngay vá»›i team data nhÃ©: JD Ä‘Ã¢y nÃ¨ (Hoáº·c gá»­i CV vÃ o mail mÃ¬nh hien.pham2@tiki.vn)\nBá»‘i cáº£nh BÃ i viáº¿t nÃ y lÃ  cÃ¡ch mÃ¬nh thiáº¿t káº¿ \u0026amp; tá»• chá»©c config cho airflow (trÆ°á»›c thá»m Ä‘Ãº trend lÃªn cloud).\nNáº¿u báº¡n Ä‘am mÃª vá» technical, tham kháº£o bÃ i viáº¿t Path to airflow 2 á»Ÿ TIKI nhÃ©.\nNhá»¯ng váº¥n Ä‘á» Ä‘á»‘i vá»›i cÃ¡ch viáº¿t dags hiá»‡n táº¡i:\n Nhá»¯ng chuá»•i ngÃ y copy - paste lÄƒp Ä‘i láº·p láº¡i (nghe giá»‘ng DRY - Don\u0026rsquo;t Repeat Your Self Principle khÃ´ng). Náº¿u khÃ´ng Ä‘Æ°á»£c tá»• chá»©c Ä‘Ãºng cÃ¡ch, reviews ká»¹ lÆ°á»¡ng cÃ³ thá»ƒ dáº«n Ä‘áº¿n con Ä‘Æ°á»ng Ä‘áº­p Ä‘i xÃ¢y láº¡i má»™t ngÃ y khÃ´ng xa (duplicated and unmaintainable code). Non - tech users (cÃ¡c báº¡n analytics, BA \u0026hellip;) pháº£i tá»‘n thá»i gian há»c python, cÃ¡ch import module nhÆ° tháº¿ nÃ o cho Ä‘Ãºng. Äiá»u nÃ y dáº«n Ä‘áº¿n má»™t lÃºc nÃ o Ä‘Ã³ cÃ¡c chÃº culi 4.0 (aka data engineer) pháº£i ngá»“i viáº¿t dÃ¹m dags cho cÃ¡c em xinh Ä‘áº¹p =)) (Cho chá»«a tá»™i mÃª gÃ¡i) We can do better!  Tháº¿ lÃ  nÃ´ng dÃ¢n quyáº¿t tÃ¢m thiáº¿t káº¿ má»™t cÃ¡ch viáº¿t riÃªng Ä‘á»ƒ cÃ³ thá»ƒ viáº¿t dag má»™t cÃ¡ch á»•n Ä‘á»‹nh nháº¥t nháº¥t, ká»ƒ cáº£ khi core cá»§a airflow thay Ä‘á»•i (vÃ­ dá»¥ import path thay Ä‘á»•i, params thay Ä‘á»•i \u0026hellip;)\nResearch (LÃºc nÃ y lÃ  thÃ¡ng 09/2019) MÃ¬nh báº¯t Ä‘áº§u thá»­ vá»›i cÃ¡c keywords: dag config, dag factory, dag yaml, \u0026hellip;\nResearch 1 há»“i thÃ¬ tÃ¬m Ä‘Æ°á»£c dag-factory opensource, tÆ°Æ¡ng lai Ä‘Ã¢y rá»“i.\nVá»›i dag-factory thÃ¬ cÃ³ 1 sá»‘ váº¥n Ä‘á» mÃ¬nh cáº§n giáº£i quyáº¿t:\n users váº«n pháº£i input full cÃ¡i import path cho operator â†’ Cáº§n páº£i táº¡o alias name  VÃ­ dá»¥ airflow.operators.bash_operator.BashOperator â†’ BashOperator   Chá»‰ cáº§n input nhá»¯ng thÃ´ng tin quan trong.  vd vá»›i operator airflow.contrib.operators.bigquery_operator.BigQueryOperator chá»‰ cáº§n truyá»n vÃ o: sql , destination_dataset_table. KhÃ´ng cáº§n pháº£i truyá»n thÃªm gcp_conn_id, cÃ¡i option nhÆ° create_disposition, write_disposition   Tá»± Ä‘á»™ng phÃ¢n quyá»n dags \u0026amp; set connection_id tÆ°Æ¡ng á»©ng cho má»—i team.  vd team 1 thÃ¬ dÃ¹ng bigquery_conn_id=team1, dÃ¹ users cÃ³ truyá»n connection_id thÃ¬ váº«n pháº£i override á»Ÿ code.   Cáº§n pháº£i force má»™t sá»‘ conventions:  Má»—i team sáº½ cÃ³ 1 prefix riÃªng, tiá»‡n cho viá»‡c phÃ¢n biá»‡t. TÃªn file = tÃªn dag â†’ Dá»… debug khi cÃ³ biáº¿n.    â‡’ Pháº£i Ä‘á»•i má»™t xÃ­u cÃ¡i lib dag factory nÃ y.\nLet\u0026rsquo;s start ! Vá»›i nhá»¯ng tinh hoa Ä‘Æ°á»£c há»c tá»« thanh niÃªn cá»©ng (SOLID), Open for Extension, Closed For Modification. Giá» khÃ´ng Ä‘uá»£c thay Ä‘á»•i code cá»§a dag-factory mÃ  mÃ¬nh sáº½ extend nÃ³.\nTá»©c lÃ  thay vÃ¬ vÃ o edit code Ä‘á»ƒ support gáº¯n conn_id, operator alias thÃ¬ mÃ¬nh sáº½ táº¡o thÃªm 1 layer phÃ­a trÃªn vÃ  tiáº¿n hÃ nh convert nÃ³ Ä‘Ãºng vá»›i format mÃ  dag-factory cáº§n.\nBáº¯t Ä‘áº§u vá»›i thiáº¿t káº¿ alias cho operators\nclass OperatorAlias: # alias name: BigQueryOperator name: str # full module path: airflow.providers.google.cloud.operators.bigquery.BigQueryExecuteQueryOperator module: str # json schema, use for validate the user inputs. # {\u0026#34;type\u0026#34;: \u0026#34;object\u0026#34;, \u0026#34;properties\u0026#34;: {\u0026#34;sql\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;string\u0026#34;, \u0026#34;minLength\u0026#34;: 2 }}, \u0026#34;required\u0026#34;: [\u0026#34;sql\u0026#34;]} schema: dict # set the default params like connections ... # {\u0026#34;bigquery_conn_id\u0026#34;: \u0026#34;gcp_girls\u0026#34;, \u0026#34;allow_large_results\u0026#34;: true, ...} default_params: dict Vá»›i thiáº¿t káº¿ 1 alias nhÆ° trÃªn, bÃ¢y giá» thay vÃ¬ pháº£i viáº¿t má»™t file python nhÆ° tháº¿ nÃ y\nfrom airflow import DAG from airflow.providers.google.cloud.operators.bigquery import BigQueryExecuteQueryOperator from .. import BigQueryTableToOLAPOperator default_args = { \u0026#39;owner\u0026#39;: \u0026#39;my@names.com\u0026#39;, } with DAG( \u0026#39;tutorial\u0026#39;, default_args=default_args, schedule_interval=\u0026#39;0 3 * * *\u0026#39;, tags=[\u0026#39;dwh\u0026#39;,\u0026#39;etl\u0026#39;], ) as dag: t1 = BigQueryExecuteQueryOperator( task_id=\u0026#39;ext_girls\u0026#39;, sql=\u0026#39;SELECT * FROM girls WHERE age \u0026gt;= 18 and age \u0026lt;= 30\u0026#39;, destination_dataset_table=\u0026#39;tiktok_clone.girls_available\u0026#39;, gcp_conn_id=\u0026#39;gcp_girls\u0026#39;, create_disposition=\u0026#34;CREATE_IF_NEEDED\u0026#34;, write_disposition=\u0026#34;WRITE_TRUNCATE\u0026#34;, allow_large_results=True, ) t2 = BigQueryTableToOLAPOperator( task_id=\u0026#39;sync_to_olap\u0026#39;, table=\u0026#39;tiktok_clone.girls_available\u0026#39;, gcp_conn_id=\u0026#39;gcp_girls\u0026#39;, druid_conn_id=\u0026#39;k8s_druid\u0026#39;, date_column=\u0026#39;date\u0026#39;, ) t1 \u0026gt;\u0026gt; t2 Chá»‰ cáº§n viáº¿t 1 file yaml.\n# ext_available_girls.yaml default_args: owner: \u0026#39;my@names.com\u0026#39; schedule_interval: \u0026#39;0 3 * * *\u0026#39; tags: - dwh - etl tasks: ext_girls: operator: BigQueryOperator sql: \u0026#39;SELECT * FROM girls WHERE age \u0026gt;= 18 and age \u0026lt;= 30\u0026#39; destination_dataset_table: tiktok_clone.girls_available sync_to_olap: operator: BigQueryTableToOLAPOperator table: tiktok_clone.girls_available druid_destination_table: girls_available dependencies: - ext_girls Xá»‹n rá»“i, coi ngÃ y \u0026amp; deploy thÃ´i anh em Æ¡i.\nPhÃ¢n Quyá»n PoC (Proof of Concept) cÆ¡ báº£n Ä‘Ã£ hoáº¡t Ä‘á»™ng Ä‘Æ°á»£c, tiáº¿p theo cáº§n pháº£i giáº£i quyáº¿t váº¥n Ä‘á» tá»± Ä‘á»™ng phÃ¢n quyá»n \u0026amp; set cÃ¡c connections for má»—i team.\nMá»—i team sáº½ cÃ³ 1 role riÃªng, cÃ¡c DAG sáº½ Ä‘Æ°á»£c gáº¯n quyá»n read trÃªn role nÃ y.\nÃ tÆ°á»Ÿng ban Ä‘áº§n lÃ  má»—i team sáº½ cÃ³ role riÃªng, cÃ¡c connection_id, \u0026amp; alert connection_id riÃªng luÃ´n.\nteams: - name: finances # airflow role_id role_id: 6 # custom alert channel: telegram, slack ... alert: kind: telegram conn_id: fin_alert # force connection_id for a team conns: - conn_id: gcp_team_2 replace_fields: - bigquery_conn_id - gcp_conn_id - google_cloud_storage_conn_id - google_cloud_conn_id Vá»›i config nhÆ° trÃªn thÃ¬ biáº¿t Ä‘á»c yaml á»Ÿ folder nÃ o, vÃ  tháº¿ lÃ  mÃ¬nh Ä‘Ã£ nghÄ© ra cÃ¡ch Ä‘Æ¡n giáº£n lÃ  pháº£i báº¯t buá»™c cÃ¡c file yaml pháº£i Ä‘Æ°á»£c Ä‘áº·t vÃ o thÆ° má»¥c vá»›i name tÆ°Æ¡ng á»©ng. VÃ­ dá»¥ (dags/finances)\nÄáº¿n Ä‘Ã¢y chá»‰ viá»‡c viáº¿t 1 script python sÆ°Æ¡ng sÆ°Æ¡ng duyá»‡t folder, parse yaml vÃ :\n Gáº¯n failed_callback tÆ°Æ¡ng vá»›i alert connection_id. Náº¿u match replace_fields thÃ¬ tiáº¿n hÃ nh thay tháº¿ luÃ´n. Vá» roles: Sau khi nghiÃªn cá»©u thÃ¬ mÃ¬nh phÃ¡t hiá»‡n Airflow sá»­ dá»¥ng flask-appbuilders, dáº«n Ä‘áº¿n chá»‰ cáº§n viáº¿t 1 cÃ¢u SQL nhá» nhá» Ä‘á»ƒ insert quyá»n read vÃ o báº£ng ab_permission_view_role vá»›i dag_id lÃ  Ä‘á»§ xÃ i (Hack nhÃ©, cáº©n tháº­n sáº­p =]])  Káº¿t luáº­n WorkFlow  Update SQL, thÃªm step git commit -m \u0026quot;fix things\u0026quot; git push Pull Request \u0026amp; Merge -\u0026gt; Há»‡ thá»‘ng sáº½ validate, gáº¯n cÃ¡c alert khi dag failed, tá»± Ä‘á»™ng retry, \u0026hellip; Done  Æ¯u Ä‘iá»ƒm  Tiáº¿t kiá»‡m thá»i gian. Vá»›i cÃ¡ch viáº¿t má»›i, bÃ¢y giá» má»i ngÆ°á»i Ä‘á»u cÃ³ thá»ƒ dá»… dÃ ng viáº¿t pipeline riÃªng cho mÃ¬nh. Tháº­m chÃ­ cÃ³ thá»ƒ viáº¿t thÃªm task ML training, prediction cÃ¡c thá»©. KhÃ´ng tá»‘n quÃ¡ nhiá»u thá»i gian Ä‘á»ƒ debug, vÃ¬ náº¿u dag khÃ´ng Ä‘Ãºng format thÃ¬ Ä‘Ã£ cÃ³ alert ngay láº­p tá»©c. Declarative \u0026amp; Abstraction: Users khÃ´ng cáº§n pháº£i biáº¿t quÃ¡ chi tiáº¿t vá» má»—i operator cÃ³ nhá»¯ng gÃ¬, chá»‰ cáº§n Ä‘iá»n nhá»¯ng field Ä‘á»§ Ä‘á»ƒ run (táº¥t nhiÃªn váº«n cáº§n pháº£i Ä‘á»§ flexible Ä‘á»ƒ cÃ³ thá»ƒ tÃ¹y biáº¿n khi cáº§n thiáº¿t) Tá»± Ä‘á»™ng gáº¯n alert khi dag failed. (MÃ  Ä‘á»‘i vá»›i python pháº£i import tay vÃ o tá»«ng DAG). Dá»… cho viá»‡c upgrade airflow: BÃ¢y giá» viá»‡c upgrade airflow khÃ´ng cÃ²n lÃ  Ã¡m áº£nh.  Náº¿u airflow Ä‘á»•i import path â‡’ mÃ¬nh chá»‰ cáº§n táº¡o Ä‘á»•i module path trong báº£ng operators lÃ  xong. Náº¿u airflow Ä‘á»•i field name, mÃ¬nh táº¡o 1 operator adapter vÃ  trá» module path tá»›i operator mÃ¬nh vá»«a táº¡o. Life\u0026rsquo;s so easy.   Tá»± Ä‘á»™ng phÃ¢n quyá»n:  Thá»±c táº¿ á»Ÿ TIKI cÃ³ khÃ¡ nhiá»u team, \u0026amp; má»—i team muá»‘n dag nhÃ  ai náº¥y á»Ÿ. VÃ¬ váº­y mÃ¬nh Ä‘Ã£ chia má»—i team 1 cÃ³ 1 folder riÃªng trong git, hoáº·c tháº­m chÃ­ lÃ  1 git repo riÃªng luÃ´n, cÃ³ role riÃªng. Má»—i khi gen dag thÃ nh cÃ´ng, thÃ¬ cÅ©ng sáº½ auto update role tÆ°Æ¡ng á»©ng cho dag Ä‘Ã³.    FAQ 1. Táº¡i sao khÃ´ng lÃ m UI cho anh em kÃ©o tháº£ luÃ´n cho tiá»‡n ? CÃ¡i nÃ y hay nÃ¨, Ä‘á»£i báº¡n vÃ o contribute Ä‘Ã³ (check JD nha)\nThá»±c táº¿ biáº¿t vá» git \u0026amp; version control nÃ³i lÃ  má»™t Ä‘iá»ƒm máº¡nh ráº¥t lá»›n cho cÃ¡c báº¡n analytics, tháº­m chÃ­ cáº£ BA. VÃ¬ váº­y mÃ¬nh quyáº¿t Ä‘á»‹nh váº«n giá»¯ git lÃ m nÆ¡i lÆ°u giá»¯ cÃ¡c file yaml trÃªn.\n2 Æ°u Ä‘iá»ƒm lá»›n cá»§a version control:\n Theo dÃµi Ä‘Æ°á»£c thay Ä‘á»•i tá»« lÃºc má»™t file Ä‘Æ°á»£c sinh ra: ai Ä‘á»•i, Ä‘á»•i vÃ¬ lÃ½ do gÃ¬. Náº¿u cÃ³ biáº¿n gÃ¬ Ä‘á»u cÃ³ thá»ƒ quay vá» phiÃªn báº£n á»•n Ä‘á»‹nh nháº¥t. VÃ  sau Ä‘Ã³ blame ngÆ°á»i phÃ¡t =]]. Cho phÃ©p nhiá»u ngÆ°á»i cÃ¹ng lÃ m viá»‡c chung vá»›i nhau trÃªn 1 project, tháº­m chÃ­ lÃ  1 file.  2. 500 anh em xÃ i chung 1 con airflow, cÃ³ bá»‹ káº¹t phÃ  giá» cao Ä‘iá»ƒm khÃ´ng chÃº? Vá» máº·t thiáº¿t káº¿ há»‡ thá»‘ng, ngay tá»« Ä‘áº§u mÃ¬nh chá»n kubernetes \u0026amp; cÃ i Ä‘áº·t Ä‘á»ƒ nÃ³ cÃ³ thá»ƒ tá»± Ä‘á»™ng nÃ¢ng thÃªm resources \u0026amp;\u0026amp; chá»n nodes khÃ¡c nhau khi cÃ³ nhiá»u job cháº¡y (autoscaler). Thá»±c táº¿ mÃ¬nh ghi nháº­n Ä‘Æ°á»£c cÃ³ lÃºc Ä‘áº¡t 600 jobs cháº¡y Ä‘á»“ng thá»i.\nTháº­m chÃ­ lÃ  chá»n Ä‘Æ°á»£c nodes máº¡nh Ä‘á»ƒ run cÃ¡c job tá»‘n nhiá»u resources:\n VÃ­ dá»¥ training model thÃ¬ cháº¡y trÃªn con vÃ i chá»¥c CPU. Nhá»¯ng job Ä‘Æ¡n giáº£n nhÆ° chá»‰ run SQL thÃ¬ cháº¡y nodes nhá» hÆ¡n.  Nhá»¯ng cÃ¡i nÃ y hoÃ n toÃ n tá»± Ä‘á»™ng \u0026amp; anh em khÃ´ng cáº§n pháº£i lÃ m gÃ¬ thÃªm.\n(Autoscaling \u0026amp; Distributed Ä‘áº¥y =]])\nCáº§n cáº£i tiáº¿n. Nhá»¯ng thiáº¿t káº¿ nÃ y chá»‰ lÃ  bÆ°á»›c Ä‘áº§u, cÃ²n ráº¥t nhiá»u room Ä‘á»ƒ cáº£i thiá»‡n thÃªm, 1 case ráº¥t Ä‘iá»ƒn hÃ¬nh nhÆ°: KÃ©o tháº£ dags nÃ¬: Thay vÃ¬ pháº£i ngá»“i viáº¿t yaml, cá»±c nhá»c há»c git, chá»‰ viá»‡c lÃªn UI kÃ©o tháº£ cÃ¡c thá»© \u0026amp; Táº¡o ngay 1 dags cho mÃ¬nh.\nResources Nhá»¯ng thiáº¿t káº¿ nÃ y mÃ¬nh Ä‘Ã£ hoÃ n thÃ nh vÃ o 2019, nhÆ°ng mÃ  idea cá»§a nÃ³ mÃ¬nh vá»«a gáº·p láº¡i 2 á»Ÿ 2 bÃ i viáº¿t khÃ¡ hay.\n Data Engineers Shouldn\u0026rsquo;t Write Airflow Dags Data Engineers Shouldn\u0026rsquo;t Write Airflow Dagsâ€Š-â€ŠPart 2  1 phÃºt quáº£ng cÃ¡o\n Báº¡n Ä‘ang mong muá»‘n tÃ¬m kiáº¿m cÆ¡ há»™i má»›i Báº¡n muá»‘n lÃ m viá»‡c vá»›i nhá»¯ng cÃ´ng nghá»‡ big data tá»‘i tÃ¢n nháº¥t. XÃ i serveless tá»‘n kÃ©m quÃ¡ vá»›i cháº­m cháº¡p, báº¡n cÃ³ thá»ƒ tá»± build \u0026amp; publish cho hÆ¡n 500 anh em TIKI xÃ i.  Äáº¿n ngay vá»›i team data nhÃ©: JD Ä‘Ã¢y nÃ¨ (Hoáº·c gá»­i CV vÃ o mail mÃ¬nh hien.pham2@tiki.vn)\n","permalink":"haongo.me/posts/airflow-dags-the-right-way/","summary":"TLDR;\nSau khi gáº·p khÃ¡ nhiá»u váº¥n Ä‘á» vá»›i lÆ°á»£ng lá»›n python DAG khi upgrade, viáº¿t giÃºp dag \u0026amp; sau má»™t thá»i gian thÃ nh con rÆ¡i, khÃ´ng ai maintain ná»¯a.\nMÃ¬nh tin ráº±ng nháº¥t Ä‘á»‹nh cÃ³ má»™t cÃ¡ch viáº¿t dags khÃ¡c:\n ÄÆ¡n giáº£n \u0026amp; hiá»‡u quáº£ hÆ¡n tháº¿ 500 anh em BA, Analytics cÃ³ thá»ƒ dá»… dÃ ng tá»± viáº¿t pipelines cho riÃªng mÃ¬nh mÃ  khÃ´ng pháº£i tá»‘n quÃ¡ nhiá»u cÃ´ng sá»©c Dá»… dÃ ng cho viá»‡c monitor, alerting khi cÃ³ biáº¿n xáº£y ra Upgrade core cá»§a airflow khÃ´ng cáº§n pháº£i thay Ä‘á»•i cÃ¡c dags config hiá»‡n táº¡i.","title":"Airflow Dags The Right Way"},{"content":"Airflow in the nut shell:\n Má»™t phiÃªn báº£o cron tab (cháº¡y má»—i ngÃ y, má»—i tuáº§n, má»—i giá» má»—i thÃ¡ng) vá»›i UI xá»‹n xÃ². CÃ¡c tÃ­n Ä‘á»“ data hay sá»­ dá»¥ng Ä‘á»ƒ viáº¿t ETL (Extract Transform Load) job  VÃ­ dá»¥ nhÆ° lÃ  select vÃ o rows tá»« MySQL ThÃªm Ã­t gia vá»‹ (Cooking) Load vÃ o Datawarehouse    KÃ© vÃ i miáº¿ng quáº£ng cÃ¡o\n Báº¡n Ä‘ang mong muá»‘n tÃ¬m kiáº¿m cÆ¡ há»™i má»›i Báº¡n muá»‘n lÃ m viá»‡c vá»›i nhá»¯ng cÃ´ng nghá»‡ big data tá»‘i tÃ¢n nháº¥t. XÃ i serveless tá»‘n kÃ©m quÃ¡ vá»›i cháº­m cháº¡p, báº¡n cÃ³ thá»ƒ tá»± build \u0026amp; publish cho hÆ¡n 500 anh em TIKI xÃ i.  Äáº¿n ngay vá»›i team data nhÃ©: JD Ä‘Ã¢y nÃ¨\nMá»›i vÃ o nghá» Team Data Platform cá»§a Tiki sá»­ dá»¥ng Apache Airflow tá»« nhá»¯ng ngÃ y Ä‘áº§u láº­p team tá»« nÄƒm 2017. Cho tá»›i hÃ´m nay kiáº¿n trÃºc \u0026amp; cÃ¡ch sá»­ dá»¥ng airflow cÅ©ng thay Ä‘á»•i khÃ¡ Ä‘Ã¡ng ká»ƒ. BÃ i viáº¿t nÃ y sáº½ chia sáº½ cÃ¡ch mÃ  Team Data cá»§a dá»¥ng airflow, Æ°u nhÆ°á»£c Ä‘iá»ƒm cá»§a cÃ¡c cÃ¡ch dÃ¹ng.\nNgÃ y xá»­a ngÃ y xÆ°a.\nKhi mÃ¬nh vÃ o TIKI vÃ o T9/2018, má»™t láº§n Ä‘Æ°á»£c cho vÃ o con airflow chÃ­nh, má»™t cÃ¡ch ngÃ¢y thÆ¡ updates 1 packages.\n# TLDR: # virtualenv python 2 \u0026amp; airflow 1.8 pip install --upgrade pandas-gbq supervisorctl restart all exit Sau Ä‘Ã³ táº¯t mÃ¡y Ä‘i ngá»§, tá»›i chiá»u anh em ping nhau, Airflow ra Ä‘i rá»“i cÃ¡c bÃ¡c áº¡, RÃ¬ pá»t ra Ä‘i háº¿t rá»“i Ã´ng giÃ¡o áº¡. Nghe xong tÃ¨ ra quáº§n luÃ´n.\nMistakes:\n KhÃ´ng backup virtualenv trÆ°á»›c khi run pip install  NÃ´ng dÃ¢n táº­p thÃ nh cloud 1 nÄƒm sau (T9/2019)\nThá»i Ä‘iá»ƒm nÃ y TIKI migrate tá»« Data Center lÃªn (GCP) Google Cloud Platform. Tháº¿ lÃ  pháº£i chuáº©n bá»‹ bÆ°ng há»‡ thá»‘ng má»™t láº§n ná»¯a.\ná» thá»i Ä‘iá»ƒm nÃ y cÃ³ 3 con airflow Ä‘ang cháº¡y:\n 1 con cháº¡y jobs ETL (Airflow 1.8) 1 con cháº¡y sync snapshot tá»« MySQL/Postgres lÃªn BigQuery (Airflow 1.8)  NghÄ©, giá» lÃªn cloud mÃ  xÃ i cÃ´ng nghá»‡ out date thÃ¬ nÃ´ng dÃ¢n quÃ¡. Quyáº¿t tÃ¢m chÆ¡i lá»›n cÃ i airflow latest luÃ´n. DAG thÃ¬ cháº¯c chá»‰ cáº§n copy qua lÃ  xong, khÃ´ng vá»¡ gÃ¬ Ã¢u.\nÄÆ°á»£c cáº¥p 1 con VM má»›i trÃªn GCP \u0026amp; ssh vÃ o pip install liá»n.\nÄang Ä‘á»£i thÃ¬ tá»± tÃ¡t cÃ¡i báº¿p. Há»c Infras As Code cÃ¡c thá»© rá»“i mÃ  láº¡i tay chÃ¢n tháº¿. Tháº¿ lÃ  ngá»“i viáº¿t ansible Ä‘á»ƒ cÃ i airflow =)). Pip install thÃ¬ vÃ i phÃºt, ngá»“i viáº¿t máº¥t vÃ i tiáº¿ng.\nCopy dag nÃ o thÃ¬ dags Ä‘Ã³ vá»¡\n PhÃ¡t hiá»‡n ra lÃ  import path \u0026amp; params Ä‘Ã£ thay Ä‘á»•i khÃ¡ nhiá»u tá»« 1.8 lÃªn 1.10. (LÃºc nÃ y cÃ²n ngÃ¢y thÆ¡ mÃ ) HÃ nh ngáº­p máº·t rá»“i, kiá»ƒu nÃ y migrate cháº¯c tá»›i táº¿t, trong khi anh em lÃºc Ä‘Ã³ cÃ²n 15 ngÃ y Ä‘á»ƒ cutdown.  Ngá»“i nghÄ© nghÄ©, máº¿u Ä‘Æ°á»£c, tháº¿ nÃ y sau nÃ y kiá»ƒu gÃ¬ cÅ©ng sáº½ gáº·p case tÆ°Æ¡ng tá»±.\nLÃºc nÃ y sau 1 thá»i gian Ä‘Æ°á»£c rÃ¨n luyá»‡n ansible vÃ  táº­p lÃ m vÄƒn kubernetes manifests báº¯t Ä‘áº§u cÃ³ Ã½ tÆ°á»Ÿng cháº¿ 1 yaml Ä‘á»ƒ viáº¿t config \u0026amp; build nÃ³ thÃ nh dag.\nXem bÃ i viáº¿t nÃ \nTLDR:\n MÃ¬nh viáº¿t thÃªm 1 lá»›p Ä‘á»ƒ set default (giÃ¡ trá»‹ máº·c Ä‘á»‹nh cá»§a cÃ¡c field), tÃªn Operator ngáº¯n gá»n xÃºc tÃ­ch thay vÃ¬ pháº£i import 1 path dÃ i ngoáº±n. Tá»± Ä‘á»™ng phÃ¢n quyá»n cho dag, alert callback vÃ o slack/telegram khi dag failed. Má»—i team cÃ³ 1 folder riÃªng trong git hoáº·c thÃ­ch thÃ¬ cho hÄƒn luÃ´n 1 git repo riÃªng.  Tiáº¿p theo lÃ  giá» sáº½ deploy á»Ÿ Ä‘Ã¢u Ä‘Ã¢y?\nTuy lÃ  nÃ´ng dÃ¢n nhÆ°ng váº«n ráº¥t thÃ­ch Ä‘Ãº trend Cá» lÃ¢u nÃ¢y tÃ­p (Cloud Native) tháº¿ lÃ  báº¯t tay vÃ o nghiÃªn cá»©u Ä‘á»ƒ cháº¡y trÃªn kubernetes luÃ´n.\n CeleryExecutor: cÃ³ sáºµn helm chart airflow Ä‘á»ƒ cÃ i. Tuy nhiÃªn láº¡i gáº·p váº¥n Ä‘á» lÃ  chÃºng ta pháº£i táº¡o trÆ°á»›c workers \u0026amp; viá»‡c tá»± Ä‘á»™ng scale cÅ©ng khÃ´ng dá»… dÃ ng gÃ¬. KubernetesExecutor: cÃ³ thá»ƒ tá»± Ä‘á»™ng táº¡o Pod Ä‘á»ƒ run task mÃ  khÃ´ng cáº§n pháº£i táº¡o worker trÆ°á»›c. Náº¿u executor nÃ y káº¿t vá»›i vá»›i autoscaler \u0026amp; Preemtible Pool cá»§a gke thÃ¬ tuyá»‡t vá»i Ã´ng máº·t zá»i. Chá»‘t nhanh chá»‘t nhanh.  NghiÃªn cá»©u vÃ i nÃ y thÃ¬ cÅ©ng báº¯t Ä‘áº§u vÃ o thiáº¿t káº¿ \u0026amp; báº¯t tay vÃ o viáº¿t k8s manifest.\nNhá»¯ng tiÃªu chÃ­ khi deploy airflow trÃªn k8s.\n Pháº£i tiáº¿t kiá»‡m: báº±ng cÃ¡ch tá»± scale node khi cáº§n (Ä‘iá»u nÃ y thÃ¬ autoscalercá»§a gke Ä‘Ã£ lÃ m ráº¥t tá»‘t. Má»™t cÃ¡ch khÃ¡c mÃ¬nh nghÄ© tá»›i lÃ  sá»­ dá»¥ng Preemptible VM cá»§a GCP: Vá»›i loáº¡i VM nÃ y thÃ¬ thá»i gian tá»‘i Ä‘a cá»§a lÃ  24h sau khi Ä‘Æ°á»£c táº¡o. Google cÃ³ thá»ƒ láº¥y láº¡i (reclaim) báº¥t kÃ¬ thá»i Ä‘iá»ƒm nÃ o.  Vá»›i nhá»¯ng yÃªu cáº§u nhÆ° trÃªn thÃ¬ mÃ¬nh thiáº¿t káº¿ cÃ¡c deployment riÃªng nhÆ° sau:\n Scheduler: Core cá»§a toÃ n há»‡ thá»‘ng nÃªn pháº£i cá»±c kÃ¬ stable, nÃªn mÃ¬nh quyáº¿t Ä‘á»‹nh chá»n node standard. (Core cháº¿t thÃ¬ cáº­u vÃ ng cÅ©ng pháº£i bÃ¡n Ä‘i má»›i mua bÃ¡nh mÃ¬ Äƒn Ä‘Æ°á»£c). Webserver thÃ nh 1 deployment riÃªng (run trÃªn preemtible pool) Ä‘á»ƒ tiáº¿t kiá»‡m vÃ  Ä‘á»ƒ HA thÃ¬ mÃ¬nh tÄƒng â‰¥ 2 replicas + podAntiAffinity topology lÃ  kubernetes.io/hostname. Pod Ä‘Æ°á»£c táº¡o ra tá»« airflow scheduler mÃ¬nh set máº·c Ä‘á»‹nh cháº¡y qua preemtible pool (tiáº¿t kiáº¿m tiá»n Ä‘á»ƒ mua bÃ¡nh mÃ¬) \u0026amp; táº¥t nhiÃªn lÃ  cÃ³ hidden option Ä‘á»ƒ select node khÃ¡c khi cáº§n.  Vá» docker image: Thá»i Ä‘iá»ƒm nÃ y airflow chÆ°a cÃ³ official image vÃ  community docker váº«n cÃ²n thiáº¿u nhiá»u thá»©. MÃ¬nh quyáº¿t Ä‘á»‹nh viáº¿t riÃªng 1 dockerfile \u0026amp; Ä‘Æ°a vÃ o nhá»¯ng dependencies cáº§n thiáº¿t Ä‘á»§ Ä‘á»ƒ airflow cháº¡y Ä‘Æ°á»£c.\nSau khi Ä‘á»§ cÃ¡c nguyÃªn váº­t liá»‡u thÃ¬ báº¯t Ä‘áº§u lÃªn Ä‘á»“ thÃ´i.\nNgoÃ i cÃ¡ch deploy airflow thÃ¬ cÃ²n nhá»¯ng bÃ i toÃ¡n sau cáº§n giáº£i quyáº¿t\nCost Saving vs Stable\n Äá»ƒ Ä‘áº£m báº£o task cháº¡y á»•n Ä‘á»‹nh trÃªn Preemtible VM, cáº§n pháº£i báº­t auto retry cho toÃ n dag trÃªn há»‡ thá»‘ng (viá»‡c nÃ y cá»±c kÃ¬ Ä‘Æ¡n giáº£n nhá» vÃ o config engine).  LÆ°u file yaml á»Ÿ Ä‘Ã¢u?\n Viá»‡c sá»­ dá»¥ng 1 file config riÃªng, mÃ¬nh hoÃ n toÃ n cÃ³ thá»ƒ support má»™t giao diá»‡n Ä‘á»ƒ viáº¿t config hoáº·c fancy hÆ¡n lÃ  kÃ©o tháº£. NhÆ°ng nghÄ© Ä‘i nghÄ© láº¡i thÃ¬ build 1 UI nhÆ° váº­y khÃ¡ tá»‘n thá»i gian \u0026amp; láº¡i phÃ¡t sinh thÃªm pháº£i handle conflict khi nhiá»u ngÆ°á»i cÃ¹ng sá»­a 1 dag. VÃ¬ váº­y mÃ¬nh Ä‘Ã£ force má»i ngÆ°á»i dÃ¹ng Git. Code yaml sáº½ Ä‘Æ°á»£c sync vÃ o deployment Dag Importer, á»Ÿ Ä‘Ã¢y yaml sáº½ Ä‘Æ°á»£c validate \u0026amp; convert thÃ nh python DAG file. Sau khi cÃ³ file DAG, tá»›i váº¥n Ä‘á» tiáº¿p theo.  LÆ°u dag á»Ÿ Ä‘Ã¢u?\n LÆ°u tháº³ng trong images: cÃ³ nhÆ°á»£c Ä‘iá»ƒm lÃ  pháº£i build image liÃªn tá»¥c khi cÃ³ thay Ä‘á»•i â†’ KhÃ³ optimize Ä‘Æ°á»£c Pod startup time do pháº£i check Pull Image. Build docker cÃ³ 1 nhÆ°á»£c Ä‘iá»ƒm lÃ  khÃ¡ cháº­m. LÆ°u á»Ÿ Shared Stores: Hiá»‡n gáº¡i Persistent Disk cá»§a gke chÆ°a support Read Write Many , Ä‘iá»u nÃ y dáº«n Ä‘áº¿n pháº£i sá»­ dá»¥ng NFS. IOPS cá»§a NFS cá»±c ká»³ tháº¥p so vá»›i SSD. Viá»‡c chá»n storage nÃ o phá»¥ thuá»™c ráº¥t nhiá»u vÃ o kiáº¿n trÃºc cá»§a airflow: Sau khi nghiÃªn cá»©u 1 há»“i thÃ¬ mÃ¬nh nháº­n tháº¥y lÃ  airflow sáº½ serialized dag vÃ o database, webserver \u0026amp; cÃ¡c worker Ä‘á»u Ä‘á»c tá»« database nÃ y.  â‡’ VÃ¬ váº­y mÃ¬nh chá»n shared storages: khÃ´ng áº£nh hÆ°á»Ÿng nhiá»u tá»›i thá»i gian cháº¡y task, 1 Æ°u Ä‘iá»ƒm ná»¯a lÃ  nÃ³ Ä‘Æ¡n giáº£n hÆ¡n architect cá»§a há»‡ thá»‘ng.\nLogging nhÆ° tháº¿ nÃ o?\n Khi lÃªn kubernetes option báº¯t buá»™c lÃ  pháº£i chá»n 1 remote logging (cá»¥ thá»ƒ thÃ¬ mÃ¬nh chá»n gcs Ä‘á»ƒ lÆ°u) NhÆ°ng remote logging gáº·p pháº£i váº¥n Ä‘á» lÃ  khÃ´ng xem Ä‘Æ°á»£c lÃºc task Ä‘ang cháº¡y. Dáº«n Ä‘áº¿n mÃ¬nh pháº£i workaround báº±ng cÃ¡ch sá»­ dá»¥ng 1 file system táº¡m Ä‘á»ƒ lÆ°u logs cá»§a task Ä‘ang cháº¡y. CÃ²n Ä‘uá»ng nÃ o ngoÃ i NFS ná»¯a Ä‘Ã¢u.  Authentication \u0026amp; Authorization\n MÃ¬nh Ä‘á»‹nh hÆ°á»›ng build Airflow trá»Ÿ thÃ nh 1 open platform, má»i ngÆ°á»i Ä‘á»u cÃ³ thá»ƒ viáº¿t config \u0026amp; cháº¡y. Äá»‘i vá»›i Ä‘á»‹nh hÆ°á»›ng nhÆ° váº­y, báº¯t buá»™c pháº£i phÃ¢n quyá»n tháº­t ká»¹ \u0026amp; tá»‘t nháº¥t lÃ  á»Ÿ DAG level. CÅ©ng khÃ¡ may lÃ  airflow support Oauth2 \u0026amp; cáº£ access á»Ÿ DAG level. Viá»‡c nÃ y trá»Ÿ nÃªn khÃ¡ Ä‘Æ¡n giáº£n khi mÃ  config system Ä‘Ã£ add sáºµn DAG vÃ o má»—i role.  Monitor \u0026amp; Alerting\n Vá»›i há»‡ thá»‘ng config thÃ¬ mÃ¬nh Ä‘Ã£ tá»± Ä‘á»™ng gáº¯n sáºµn task_failed_callback. Má»—i team sáº½ Ä‘uá»£c táº¡o 1 connection riÃªng (cÃ³ thá»ƒ lÃ  slack/telegram) \u0026amp; lÃºc failed thÃ¬ dag nhÃ  ai náº¥y nháº­n \u0026amp; tá»± Ä‘i check. Äá»‘i vá»›i airflow thÃ¬ mÃ¬nh sá»­ dá»¥ng Statsd Exporter Ä‘á»ƒ expose metrics API cho prometheus vÃ  lÃªn grafana táº¡o dashboard/alert.  Backfill dags nhÆ° tháº¿ nÃ o?\n NgÃ y trÆ°á»›c cÃ¡i trÃªn VM thÃ¬ hay ssh vÃ o server Ä‘á»ƒ cháº¡y airflow backfill. CÃ²n trÃªn k8s thÃ¬ ssh Ä‘Ã¢u mÃ  vÃ o. VÃ o pod Ä‘á»ƒ execute thÃ¬ nÃ³ láº¡i bá»‹ limit á»Ÿ vÃ i báº¡n engineer. VÃ¬ váº­y mÃ¬nh Ä‘Ã£ custom láº¡i 1 opensource lÃ  airflow-backfill-util \u0026amp; share quyá»n cho má»i ngÆ°á»i vÃ o backfill.  VÃ i cáº£m nháº­n:\n NFS everywhere. NÃ³i lÃ  Preemtible VM nhÆ°ng mÃ¬nh cáº£m nháº­n lÃ  khÃ¡ lÃ  stable, sau 2 nÄƒm sá»­ dá»¥ng thÃ¬ mÃ¬nh chÆ°a gáº·p váº¥n Ä‘á» gÃ¬ quÃ¡ lá»›n (CÃ³ thá»ƒ do thiáº¿t káº¿ system pro quÃ¡ nÃªn khÃ´ng bá»‹ lá»—i :\u0026quot;\u0026gt;)  LÃ¢u lÃ¢u cÃ³ vÃ i task cháº¡y hÆ¡n 5h bá»‹ down, Ä‘á»‘i vá»›i nhá»¯ng task nÃ y, mÃ¬nh question ngÆ°á»£c láº¡i táº¡i sao nÃ³ láº¡i cháº¡y lÃ¢u tháº¿ â†’optimize DAG. Äá»‘i vá»›i Data Scientist Team: MÃ¬nh white list cho viáº¿t háºµn Python code luÃ´n, cho select node xá»‹n Ä‘á»ƒ cháº¡y. Chá»› model train cÅ©ng háº¿t ná»¯a ngÃ y.   Khi cháº¡y airflow trÃªn K8S thÃ¬ Airflow khÃ´ng cÃ²n Ä‘Æ¡n thuáº§n lÃ  chá»‰ ETL ná»¯a, mÃ  cÃ³ thá»ƒ cháº¡y má»i thá»©, thanks KubernetesPodOperator.  Hiá»‡n táº¡i mÃ¬nh luÃ´n khuyáº¿n khÃ­ch cÃ¡c báº¡n Data Scientist thay vÃ¬ viáº¿t PythonOperator \u0026amp; nhá» mÃ¬nh cÃ i thÃªm dependencies vÃ o base image, thÃ¬ viáº¿t má»™t Dockerfile chá»© má»i thá»© cáº§n thiáº¿t á»Ÿ trong Ä‘Ã³ (ML Libs, C++ Libs, Code \u0026hellip;) \u0026amp; config KubernetesPodOperator. Viá»‡c nÃ y vá»«a Ä‘áº£m báº£o tÃ­nh á»•n Ä‘á»‹nh, khÃ´ng cáº§n pháº£i add nhá»¯ng thá»© khÃ´ng cáº§n thiáº¿t vÃ o base images sáº½ tá»‘n time Ä‘á»ƒ pull â†’ giáº£m startup time.    Airflow 2 Version 2.0 Ä‘Æ°á»£c release vÃ o ngÃ y 2020-12-18 tháº¿ nhÆ°ng mÃ¬nh chÆ°a dÃ¡m update ngay, vÃ¬ trÆ°á»›c giá» má»—i láº§n chá»‰ update patch version cá»§a airflow khÃ´ng quÃ¨ chá»• nÃ y thÃ¬ chá»• kia. MÃ  lá»—i gáº·p nhiá»u nháº¥t váº«n lÃ  google oauth2, vÃ  pháº§n lá»›n lÃ  do lá»—i depedencies ğŸ˜.\nSau hÆ¡n 8h thÃ¡ng delay thÃ¬ quyáº¿t tÃ¢m lÃ m 1 láº§n sau cuá»‘i.\nLÃªn danh sÃ¡ch nhá»¯ng viá»‡c cáº§n lÃ m:\n Coi ngÃ y: chá»n ngÃ y tá»‘t má»›i dÃ¡m upgrade (check xemngay.com) LÃ m theo upgrade guides: https://airflow.apache.org/docs/apache-airflow/stable/upgrading-to-2.html  LÃªn airflow 1.10.15 Install backport provider \u0026amp; update module_path vÃ o cÃ¡i operators (Ä‘Æ¡n giáº£n lÃ  update vÃ o config cá»§a operator alias). Generate pod_template_file Run airflow upgrade_check \u0026amp; fix. Äa sá»‘ lá»—i mÃ¬nh gáº·p Ä‘áº¿n tá»« cÃ¡c DAG viáº¿t báº±ng python cá»§a team Data Scientist. KhÃ´ng cÃ²n cÃ¡ch nÃ o khÃ¡c lÃ  pháº£i Ä‘i fix tay tá»«ng dag, cÅ©ng ráº¥t may lÃ  khoáº£ng chÆ°a tá»›i 20 dags.    Sau khi lÃªn bridges \u0026amp; chá»n Ä‘uá»£c ngÃ y lÃ nh thÃ¡ng tá»‘t. Báº¯t Ä‘áº§u upgrade airflow 2. á» tiki thÃ¬ Ä‘a sá»‘ DAG Ä‘Æ°á»£c cháº¡y vÃ o ban Ä‘Ãªm \u0026amp; buá»•i sÃ¡ng. RiÃªng buá»•i chiá»u \u0026amp; tá»‘i thÃ¬ ráº¥t Ã­t. Thá»i Ä‘iá»ƒm vÃ ng lÃ  Ä‘Ã¢y.\n  Backup Metadata DB: Viáº¿t tÃ¢m thÆ° gá»­i anh em system Ä‘á»ƒ lá»¡ mÃ  sá»± viá»‡c khÃ´ng thÃ nh, váº«n cÃ²n Ä‘á»«ong quay vá» nhÃ .\n  Scale Down táº¥t cáº£ services: Scheduler, WebServer, ImportDags\n  Merge Pull Request Ä‘á»ƒ Build \u0026amp; Deploy.\n  Start 1 replica WebServer, execute bash \u0026amp; run: airflow db upgrade vá»«a ngá»“i vá»«a nghe nháº¡c Ä‘á»ƒ tá»± tráº¥n an mÃ¬nh =)), chá»› lÃºc Ä‘Ã³ cÅ©ng teo háº¿t má»i thá»© rá»“i.\n  Äá»£i khoÃ ng 30 phÃºt thÃ¬ migrate run xong. MÃ¬nh báº¯t Ä‘áº§u lÃªn web ui Ä‘á»ƒ kiá»ƒm tra xem cÃ³ bá»‹ vá»¡ gÃ¬ khÃ´ng. Tháº¥y má»i thá»© cÃ³ váº» á»•n.\n  Scale scheduler lÃªn 1 replica. Tháº¥y DAG máº¿u cháº¡y, báº¯t Ä‘áº§u xanh cmn máº·t.\n KhÃ´ng run Ä‘Æ°á»£c do entrypoint trong docker Ä‘Ã£ Ä‘uá»£c add sáºµn airflow command. Sau Ä‘Ã³ args láº¡i add thÃªm airflow ná»¯a.    Sau khi fix lá»—i command thÃ¬ tháº¥y DAG báº¯t Ä‘áº§u cháº¡y: Ä‘i kiá»ƒm tra má»™t vÃ²ng thÃ¬ Ä‘a sá»‘ DAG cháº¡y ok, cÃ³ má»™t sá»‘ lá»—i váº·t khÃ¡ dá»‹:\n env_vars cá»§a KubernetesPodOperator tá»± Ä‘á»™ng nháº­n diá»‡n cÃ¡i env báº¯t Ä‘áº§u báº±ng / thÃ nh template file â†’ dáº«n Ä‘áº¿n start pod lá»—i. Bug nhá» nháº¥t lÃ  admin khÃ´ng Ä‘Æ°á»£c edit user permissions ná»¯a. Pháº£i ngá»“i Ä‘á»£i báº£n fix tiáº¿p theo thÃ´i. Logging: KhÃ´ng cÃ²n sá»­ dá»¥ng connection_id Ä‘á»ƒ láº¥y logging credention cho gcs mÃ  pháº£i mount credential vÃ o pod. Má»™t vÃ i lá»—i nhá» khÃ¡c do sá»­ dá»¥ng internal function cá»§a airflow.    VÃ i cáº£m nháº­n vá» Airflow 2:\n Performance tÄƒng khá»§ng khiáº¿p: Khi sá»‘ lá»±á»£ng DAG tÄƒng lÃªn tá»« vÃ i trÄƒm lÃªn gáº§n 2000, má»™t váº¥n Ä‘á» ráº¥t lá»›n gáº·p pháº£i Ä‘á»‘i vá»›i airflow 1 lÃ  thá»i gian delay giá»¯a cÃ¡c task trong dag ráº¥t lá»›n. Pháº£i máº¥t tá»« 5 - 15p giá»¯a cÃ¡c task \u0026amp; thá»i gian start DAG delay khoÃ ng 5 phÃºt so vá»›i giá» Ä‘Æ°á»£c set. Khi lÃªn version 2 thÃ¬ gáº§n nhÆ° vá» 0. Äiá»u nÃ y cá»±c ká»³ cÃ³ Ã½ nghÄ©a Ä‘á»‘i vá»›i nhá»¯ng task cháº¡y má»—i 1 hoáº·c 2 phÃºt. UI má»›i nhÃ¬n Ä‘áº¹p hÆ¡n háºµn \u0026amp; thá»±c táº¿ lÃ  ai cÅ©ng khen (chÃª xáº¥u lÃ  disable account nhÃ©). Viá»‡c upgrade láº§n nÃ y Ãªm hÆ¡n háºµn so vá»›i dá»± tÃ­nh cá»§a mÃ¬nh lÃ  cÃ³ thá»ƒ khÃ´ng lÃªn Ä‘Æ°á»£c  VÃ¬ mÃ¬nh tháº¥y Ä‘Æ°á»£c qua cÃ¡c láº§n upgrade trÆ°á»›c, vá»¡ ráº¥t nhiá»u chá»•    Káº¿t luáº­n CÃ²n chá» Ä‘á»£i gÃ¬ mÃ  khÃ´ng lÃªn airflow 2 ngay vÃ  thÃ´i. MÃ¬nh Ä‘Ã£ upgrade thÃ nh cÃ´ng báº¡n cÅ©ng tháº¿. VÃ  nhá»› coi ngÃ y trÆ°á»›c khi upgrade nha.\ná» trÃªn cÃ³ quáº£ng cÃ¡o rá»“i, nhÆ°ng mÃ¬nh váº«n cá»© Ä‘Äƒng láº¡i\n Báº¡n Ä‘ang mong muá»‘n tÃ¬m kiáº¿m cÆ¡ há»™i má»›i Báº¡n muá»‘n lÃ m viá»‡c vá»›i nhá»¯ng cÃ´ng nghá»‡ big data tá»‘i tÃ¢n nháº¥t. XÃ i serveless tá»‘n kÃ©m quÃ¡ vá»›i cháº­m cháº¡p, báº¡n cÃ³ thá»ƒ tá»± build \u0026amp; publish cho hÆ¡n 500 anh em TIKI xÃ i.  Äáº¿n ngay vá»›i team data nhÃ©: JD Ä‘Ã¢y nÃ¨\n","permalink":"haongo.me/posts/apache-airflow/","summary":"Airflow in the nut shell:\n Má»™t phiÃªn báº£o cron tab (cháº¡y má»—i ngÃ y, má»—i tuáº§n, má»—i giá» má»—i thÃ¡ng) vá»›i UI xá»‹n xÃ². CÃ¡c tÃ­n Ä‘á»“ data hay sá»­ dá»¥ng Ä‘á»ƒ viáº¿t ETL (Extract Transform Load) job  VÃ­ dá»¥ nhÆ° lÃ  select vÃ o rows tá»« MySQL ThÃªm Ã­t gia vá»‹ (Cooking) Load vÃ o Datawarehouse    KÃ© vÃ i miáº¿ng quáº£ng cÃ¡o\n Báº¡n Ä‘ang mong muá»‘n tÃ¬m kiáº¿m cÆ¡ há»™i má»›i Báº¡n muá»‘n lÃ m viá»‡c vá»›i nhá»¯ng cÃ´ng nghá»‡ big data tá»‘i tÃ¢n nháº¥t.","title":"Path to airflow 2"}]